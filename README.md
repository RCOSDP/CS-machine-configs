
1;95;0c# Configuring VMs in mdx with Ansible

This git repository provides examples and templates to provision
configurations on multiple VM instances in mdx. This provisioner
leverages [Ansible](https://www.ansible.com/), an open-source software
for provisioning and configuring machines.


We recommend you to briefly read [Ansible overview](https://www.ansible.com/overview/how-ansible-works) and [introduction to playbooks](https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html).

## Getting Started

Self-contianed playbooks for deploying some types of specific culsters
(but dependent on mdx) are in [example-playbooks](example-playbooks).

1. Install `ansible` on your machine that configures your VMs.

2. Download your `user-portal-vm-info.csv` from mdx portal.

3. (Need Update)


## Example Playbooks

This directory provides self-contained Ansible playbooks to provision
a cluster in mdx.

- nfs-home-cluster.yaml: Share /home directory among all VMs via NFS.

  - Required host groups: `nfsserver`, `nfsclients`

- ldap-cluster.yaml: Deploy LDAP on a cluster and create user
  accounts (depending on nfs-home-cluster.yaml).

  - Required host groups: `ldapserver`

- mpi-cluster.yaml: Configure all VMs to be capable of OpenMPI
  (installed with OFED).

  - Optional host groups: `nfsserver`

- jupyterlab-cluster.yaml: Spawn jupyter lab on all VMs, and configure
  a VM, which would have a global IPv4 address by DNAT, as a reverse
  proxy to access the jupyter lab instances.

  - Required host groups: `nginx`
  - Optional host groups: `nfsserver`, `nfsclients`


Getting Started will be documented on docs.mdx.jp...


To execude ansible-playbook, we need an inventory
file. `mdxcsv2inventory.py` helps you to generate an inventory from a
CSV file generated by the mdx user portal.

```shell-session
$ ./mdxcsv2inventory.py -h
usage: mdxcsv2inventory.py [-h] [-6] [-u ANSIBLE_USER] [-d DEFAULT_GROUP]
                           [-g GROUP REGEXP] [-gv GROUP REGEXP]
                           [--group-with GROUP [VM_NAME ...]]
                           [--group-without GROUP [VM_NAME ...]]
                           [--per-node-groups] [--enable-ethipv6]
                           [--enable-linklocal] [--output OUTPUT]
                           csv

positional arguments:
  csv                   CSV file generated by mdx user portal

optional arguments:
  -h, --help            show this help message and exit
  -6, --use-ipv6        use IPv6 address for hosts
  -u ANSIBLE_USER, --ansible-user ANSIBLE_USER
                        user to run ansible, default is mdxuser
  -d DEFAULT_GROUP, --default-group DEFAULT_GROUP
                        group name for all nodes, default is default
  -g GROUP REGEXP, --group-regexp GROUP REGEXP
                        make a group GROUP with VM names matched with REGEXP
  -gv GROUP REGEXP, --group-regexp-invert GROUP REGEXP
                        make a group GROUP without VM names matched with
                        REGEXP
  --group-with GROUP [VM_NAME ...]
                        make a group with specified VM names
  --group-without GROUP [VM_NAME ...]
                        make a group without specified VM names
  --per-node-groups     make per-node groups in the inventory
  --enable-ethipv6      enable host var 'ethipv6'
  --enable-linklocal    enable IPv6 link locak address on inventory
  --output OUTPUT       output file name, default is STDOUT
```

By default, it generates a simple inventory (to STDOUT).

The following output shows an inventory from a CSV for VMs deployed
with `vm[1-8]`.

```shell-session
$ ./mdxcsv2inventory.py user-portal-vm-info.csv
[all:vars]
ansible_user=mdxuser
ethipv4prefix=10.13.200.0/21
rdmaipv4prefix=10.141.200.0/21

[default]
10.13.200.118   hostname=vm1 ethipv4=10.13.200.118   rdmaipv4=10.141.204.34  
10.13.204.51    hostname=vm2 ethipv4=10.13.204.51    rdmaipv4=10.141.200.119 
10.13.204.47    hostname=vm3 ethipv4=10.13.204.47    rdmaipv4=10.141.204.35  
10.13.204.53    hostname=vm4 ethipv4=10.13.204.53    rdmaipv4=10.141.204.41  
10.13.200.121   hostname=vm5 ethipv4=10.13.200.121   rdmaipv4=10.141.200.122 
10.13.200.122   hostname=vm6 ethipv4=10.13.200.122   rdmaipv4=10.141.200.120 
10.13.204.48    hostname=vm7 ethipv4=10.13.204.48    rdmaipv4=10.141.204.38  
10.13.204.52    hostname=vm8 ethipv4=10.13.204.52    rdmaipv4=10.141.204.40 

```

You can generate host groups with/without specified VMs. For example,
to configure `vm1` in nfsserver group and others in nfsclients gorup:


```shell-session
$ ./mdxcsv2inventory.py user-portal-vm-info.csv --g nfsserver vm1 -gv nfsclients vm1
[all:vars]
ansible_user=mdxuser
ethipv4prefix=10.13.200.0/21
rdmaipv4prefix=10.141.200.0/21

[default]
10.13.200.118   hostname=vm1 ethipv4=10.13.200.118   rdmaipv4=10.141.204.34  
10.13.204.51    hostname=vm2 ethipv4=10.13.204.51    rdmaipv4=10.141.200.119 
10.13.204.47    hostname=vm3 ethipv4=10.13.204.47    rdmaipv4=10.141.204.35  
10.13.204.53    hostname=vm4 ethipv4=10.13.204.53    rdmaipv4=10.141.204.41  
10.13.200.121   hostname=vm5 ethipv4=10.13.200.121   rdmaipv4=10.141.200.122 
10.13.200.122   hostname=vm6 ethipv4=10.13.200.122   rdmaipv4=10.141.200.120 
10.13.204.48    hostname=vm7 ethipv4=10.13.204.48    rdmaipv4=10.141.204.38  
10.13.204.52    hostname=vm8 ethipv4=10.13.204.52    rdmaipv4=10.141.204.40  

[nfsserver]
# group with regexp 'vm1'
10.13.200.118   hostname=vm1 ethipv4=10.13.200.118   rdmaipv4=10.141.204.34  

[nfsclients]
# group without regexp 'vm1'
10.13.204.51    hostname=vm2 ethipv4=10.13.204.51    rdmaipv4=10.141.200.119 
10.13.204.47    hostname=vm3 ethipv4=10.13.204.47    rdmaipv4=10.141.204.35  
10.13.204.53    hostname=vm4 ethipv4=10.13.204.53    rdmaipv4=10.141.204.41  
10.13.200.121   hostname=vm5 ethipv4=10.13.200.121   rdmaipv4=10.141.200.122 
10.13.200.122   hostname=vm6 ethipv4=10.13.200.122   rdmaipv4=10.141.200.120 
10.13.204.48    hostname=vm7 ethipv4=10.13.204.48    rdmaipv4=10.141.204.38  
10.13.204.52    hostname=vm8 ethipv4=10.13.204.52    rdmaipv4=10.141.204.40

```

