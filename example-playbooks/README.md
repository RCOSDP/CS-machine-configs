## Example Playbooks

This directory provides self-contained Ansible playbooks to provision
a cluster on mdx.

- jupyterlab-cluster.yaml: Spawn jupyter lab on all VMs, and configure
  a VM, which would have a global IPv4 address by DNAT, as a reverse
  proxy to access the jupyter lab instances.

- mpi-cluster.yaml: Provision a cluster capable of MPI (OpenMPI
  installed along with OFED).


Getting Started will be documented on docs.mdx.jp...


To execude ansible-playbook, we need an inventory
file. `mdxcsv2inventory.py` helps you to generate an inventory from a
CSV file generated by the mdx user portal.

```shell-session
$ ./mdxcsv2inventory.py -h
usage: mdxcsv2inventory.py [-h] [-u ANSIBLE_USER] [-g DEFAULT_GROUP]
                           [--per-node-groups]
                           [--group-with GROUP [VM_NAME ...]]
                           [--group-without GROUP [VM_NAME ...]]
                           [--output OUTPUT]
                           csv

positional arguments:
  csv                   CSV file generated by mdx user portal

optional arguments:
  -h, --help            show this help message and exit
  -u ANSIBLE_USER, --ansible-user ANSIBLE_USER
                        user to run ansible, default is mdxuser
  -g DEFAULT_GROUP, --default-group DEFAULT_GROUP
                        group name for all nodes, default is default
  --per-node-groups     make per-node groups in the inventory
  --group-with GROUP [VM_NAME ...]
                        make a group with specified VM names
  --group-without GROUP [VM_NAME ...]
                        make a group without specified VM names
  --output OUTPUT       output file name, default is STDOUT
```

By default, it generates a simple inventory (to STDOUT). The following
output shows an inventory from a CSV for VMs deployed `vm[1-8]`.

```shell-session
$ ./mdxcsv2inventory.py user-portal-vm-info.csv
[all:vars]
ansbile_user=mdxuser
ethipv4prefix=10.13.200.0/21
rdmaipv4prefix=10.141.200.0/21

[default]
10.13.200.110   hostname=vm1 rdmaipv4=10.141.204.25  
10.13.200.111   hostname=vm2 rdmaipv4=10.141.200.109 
10.13.204.39    hostname=vm3 rdmaipv4=10.141.204.26  
10.13.200.117   hostname=vm4 rdmaipv4=10.141.204.31  
10.13.204.41    hostname=vm5 rdmaipv4=10.141.200.113 
10.13.204.42    hostname=vm6 rdmaipv4=10.141.204.30  
10.13.200.113   hostname=vm7 rdmaipv4=10.141.200.111 
10.13.204.43    hostname=vm8 rdmaipv4=10.141.204.28

```

You can generate host groups with/without specified VMs. For example,
to configure `vm1` as a manager and others as workers for an MPI
cluster:

```shell-session
$ ./mdxcsv2inventory.py user-portal-vm-info.csv --group-with manager vm1 --group-without workers vm1
[all:vars]
ansbile_user=mdxuser
ethipv4prefix=10.13.200.0/21
rdmaipv4prefix=10.141.200.0/21

[default]
10.13.200.110   hostname=vm1 rdmaipv4=10.141.204.25  
10.13.200.111   hostname=vm2 rdmaipv4=10.141.200.109 
10.13.204.39    hostname=vm3 rdmaipv4=10.141.204.26  
10.13.200.117   hostname=vm4 rdmaipv4=10.141.204.31  
10.13.204.41    hostname=vm5 rdmaipv4=10.141.200.113 
10.13.204.42    hostname=vm6 rdmaipv4=10.141.204.30  
10.13.200.113   hostname=vm7 rdmaipv4=10.141.200.111 
10.13.204.43    hostname=vm8 rdmaipv4=10.141.204.28  

[manager]
# group with vm1
10.13.200.110   hostname=vm1 rdmaipv4=10.141.204.25  

[workers]
# group without vm1
10.13.200.111   hostname=vm2 rdmaipv4=10.141.200.109 
10.13.204.39    hostname=vm3 rdmaipv4=10.141.204.26  
10.13.200.117   hostname=vm4 rdmaipv4=10.141.204.31  
10.13.204.41    hostname=vm5 rdmaipv4=10.141.200.113 
10.13.204.42    hostname=vm6 rdmaipv4=10.141.204.30  
10.13.200.113   hostname=vm7 rdmaipv4=10.141.200.111 
10.13.204.43    hostname=vm8 rdmaipv4=10.141.204.28  

```

The above group names fit mpi-cluster.yaml. The following commands
provison an MPI cluster based on the CSV file.

```shell-session
./mdxcsv2inventory.py user-portal-vm-info.csv --group-with manager vm1 \
  					      --group-without workers vm1 \
					      > mpi-hosts.ini

ansible-playbook -i mpi-hosts.ini mpi-cluster.yaml
```


For jupyterlab-cluster.yaml:

```shell-session
./mdxcsv2inventory.py user-portal-vm-info.csv --group-with nginx vm1 \
		      			      --group-with nfsserver vm1 \
					      --group-without nfsclient vm1 \
					      > jupyter-hosts.ini

ansible-playbook -i jupyter-hosts.ini jupyterlab-cluster.yaml
```

Assign a global IPv4 address to `vm1` by DNAT, and then you can access
jupyterlab on a VM through `http://[vm1 global addr]:8001` for
example.